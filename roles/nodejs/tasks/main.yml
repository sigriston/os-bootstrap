---
- name: install jq
  package:
    name: jq
    state: present
  become: yes

- name: get nvm latest tag
  shell: curl -sL https://api.github.com/repos/creationix/nvm/releases/latest | jq -r '.tag_name'
  register: nvm_latest_tag

- name: install nvm
  shell: "curl -o- https://raw.githubusercontent.com/creationix/nvm/{{ nvm_latest_tag.stdout }}/install.sh | bash"
  args:
    creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

- name: install node.js LTS
  shell: source "$HOME/.nvm/nvm.sh" && nvm install --lts
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.nvm/alias/default"

- name: grab node.js version
  shell: source "$HOME/.nvm/nvm.sh" && node --version
  args:
    executable: /bin/bash
  register: nodejs_version

- name: install npm global packages
  shell: "source $HOME/.nvm/nvm.sh && npm install -g {{ item }}"
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.nvm/versions/node/{{ nodejs_version.stdout }}/lib/node_modules/{{ item }}"
  loop: "{{ nodejs_packages }}"

# TODO: using the npm module is a bit better but seems broken on python 3.7
# - name: install npm global packages
#   npm:
#     name: "{{ item }}"
#     global: yes
#     state: present
#     executable: "{{ ansible_env.HOME }}/.nvm/versions/node/{{ nodejs_version.stdout }}/bin/npm"
#   loop: "{{ nodejs_packages }}"
